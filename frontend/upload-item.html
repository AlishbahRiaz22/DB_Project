<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Item | Virtual Trade</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .upload-container {
            max-width: 1000px;
            margin: 5rem auto;
            padding: 0 2rem;
            display: flex;
            gap: 3rem;
            align-items: flex-start;
        }

        .upload-form-container {
            flex: 1;
            background-color: white;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
        }

        .upload-form-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .upload-form-header h2 {
            font-size: 2.2rem;
            color: var(--organic);
            margin-bottom: 0.8rem;
        }

        .form-group {
            margin-bottom: 1.8rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.8rem;
            color: var(--organic);
            font-weight: 500;
        }

        .form-group input[type="text"],
        .form-group textarea {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input[type="text"]:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--apricot);
            box-shadow: 0 0 0 2px rgba(215, 139, 48, 0.2);
        }

        .image-upload-container {
            border: 2px dashed var(--natural);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload-container:hover {
            border-color: var(--apricot);
            background-color: rgba(215, 139, 48, 0.05);
        }

        .image-upload-container i {
            font-size: 2rem;
            color: var(--natural);
            margin-bottom: 1rem;
        }

        .upload-type-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .type-option {
            flex: 1;
            padding: 1rem;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .type-option.active {
            border-color: var(--apricot);
            background-color: rgba(215, 139, 48, 0.1);
        }

        .type-option:hover {
            border-color: var(--apricot);
        }

        .borrow-options {
            display: none;
            margin-top: 1.5rem;
        }

        .borrow-options.visible {
            display: block;
        }

        .duration-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .duration-option {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .duration-option.selected {
            background-color: var(--apricot);
            color: white;
            border-color: var(--apricot);
        }

        .upload-btn {
            width: 100%;
            padding: 1rem;
            background-color: var(--apricot);
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-btn:hover {
            background-color: var(--light-apricot);
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .preview-container {
            flex: 0 0 300px;
            position: sticky;
            top: 2rem;
        }

        .image-preview {
            width: 100%;
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .preview-placeholder {
            color: var(--natural);
            text-align: center;
        }

        .status-toggle {
            margin-top: 1.5rem;
            display: none;
            background-color: var(--ivory);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .status-toggle.visible {
            display: block;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin: 0 10px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--apricot);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .status-label {
            display: inline-block;
            vertical-align: middle;
            color: var(--organic);
            font-weight: 500;
        }

        @media (max-width: 992px) {
            .upload-container {
                flex-direction: column;
            }

            .preview-container {
                position: static;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="logo"><a href="index.html">VirtualTrade</a></div>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="category.html">Categories</a>
                <a href="how-it-works.html">How It Works</a>
                <a href="about.html">About Us</a> 
            </div>
            <div class="auth-buttons">
                <button class="login-btn" onclick="location.href='login.html'">Login</button>
                <button class="signup-btn" onclick="location.href='signup.html'">Sign Up</button>
            </div>
        </nav>
    </header>

    <main>
        <div class="upload-container">
            <div class="upload-form-container">
                <div class="upload-form-header">
                    <h2>Upload Your Item</h2>
                    <p>Share your item with the community</p>
                </div>

                <form id="uploadForm" class="upload-form">
                    <div class="upload-type-selector">
                        <div class="type-option active" data-type="borrow">
                            <h3>Borrowable</h3>
                            <p>Let others borrow your item</p>
                        </div>
                        <div class="type-option" data-type="trade">
                            <h3>Tradeable</h3>
                            <p>Exchange with other items</p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="itemName">Item Name</label>
                        <input type="text" id="itemName" required>
                    </div>

                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" rows="4" required></textarea>
                    </div>

                    <div class="hide form-group" style="display: none;"></div>

                    <div class="form-group">
                        <label>Item Image</label>
                        <div class="image-upload-container">
                            <i>üì∏</i>
                            <p>Click to upload or drag and drop</p>
                            <input type="file" id="itemImage" accept="image/*" hidden>
                        </div>
                    </div>

                    <div class="borrow-options visible">
                        <label>Available Durations</label>
                        <div class="duration-options" style="margin: 10px; display: flex; justify-content: space-around;">
                            <div class="duration-option" data-days="7">1 Week</div>
                            <div class="duration-option" data-days="14">2 Weeks</div>
                            <div class="duration-option" data-days="30">1 Month</div>
                            <div class="duration-option" data-days="90">3 Months</div>
                        </div>
                    </div>

                    <div class="status-toggle">
                        <label>Item Status</label>
                        <div class="status-wrapper">
                            <span class="status-label">Available</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="statusToggle">
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="status-label">Traded</span>
                        </div>
                    </div>

                    <button type="submit" class="upload-btn">Upload Item</button>
                </form>
            </div>

            <div class="preview-container">
                <div class="image-preview">
                    <div class="preview-placeholder">
                        <i>üñºÔ∏è</i>
                        <p>Image preview will appear here</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-col">
                <h3>VirtualTrade</h3>
                <p>Trading platform for a sustainable future.</p>
            </div>
            <div class="footer-col">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="browse.html">Browse Items</a></li>
                    <li><a href="about.html">About Us</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 Virtual Trade. All rights reserved.</p>
        </div>
    </footer>

    <script>
            const uploadForm = document.getElementById('uploadForm');
            const typeOptions = document.querySelectorAll('.type-option');
            const borrowOptions = document.querySelector('.borrow-options');
            const statusToggle = document.querySelector('.status-toggle');
            const statusSlider = document.getElementById('statusToggle');
            const imageInput = document.getElementById('itemImage');
            const imagePreview = document.querySelector('.image-preview');
            const hiddenDiv = document.querySelector('.hide');

            if (window.localStorage.getItem('loggedIn') === 'true') {
                // If the user is logged in, we update the buttons
                const signupBtn = document.querySelector('.signup-btn'); // Selecting the signup button
                const loginBtn = document.querySelector('.login-btn'); // Selecting the login button
        
                // Updating the login button to act as a link to the user's profile
                loginBtn.textContent = "";
                loginBtn.style.backgroundImage = "url('./resources/images/user.png')";
                loginBtn.style.backgroundSize = "cover";
                loginBtn.style.width = "40px";
                loginBtn.style.height = "40px";
                loginBtn.style.borderRadius = "50%";
                loginBtn.style.border = "none";
                loginBtn.style.cursor = "pointer";
                loginBtn.style.marginRight = "10px";
                loginBtn.style.padding = "0px";
                loginBtn.style.backgroundColor = "transparent";
                loginBtn.href = "#";
                loginBtn.addEventListener('click', function() {
                    window.location.href = "profile.html";
                })
        
                // Updating the signup button to act as a logout button
                signupBtn.textContent = "Logout";
                signupBtn.href = "#";
                signupBtn.addEventListener('click', async function() {
                    const response = await fetch('http://127.0.0.1:8808/logout', {
                        method: "POST",
                        credentials: 'include'
                    })
                    if(response.status === 200) {
                        // If user successfully logged out, redirect to index.html
                        // To undo the changes made to the login button, we set it back to its original state by redirection
                        window.location.href = "index.html";
                        window.localStorage.setItem('loggedIn', 'false'); // Setting the loggedIn status to false
                    }
                    else {
                        alert("Error logging out. Please try again.");
                    }
                })
            }

            // Type selector handling
            typeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    typeOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    
                    if (option.dataset.type === 'borrow') {
                        borrowOptions.classList.add('visible');
                        statusToggle.classList.remove('visible');
                        hiddenDiv.style.display = 'none';

                    } else {
                        borrowOptions.classList.remove('visible');
                        statusToggle.classList.add('visible');
                        hiddenDiv.style.display = 'block';
                        hiddenDiv.innerHTML = `
                            <label for="itemName">Token Value:</label>
                            <input type="text" id="tokenVal" required>
                        `;
                    }
                });
            });

            const tokenValInput = document.getElementById('tokenVal');

            // Image upload handling
            imageInput.addEventListener('change', handleImageUpload);
            const dropZone = document.querySelector('.image-upload-container');
            
            // Make the dropzone clickable
            dropZone.addEventListener('click', () => {
                imageInput.click();
            });
            
            // Drag and drop functionality
            dropZone.addEventListener('dragenter', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    const file = e.dataTransfer.files[0];
                    // Check if file is an image
                    if (file.type.startsWith('image/')) {
                        imageInput.files = e.dataTransfer.files;
                        handleImageUpload();
                    } else {
                        alert('Please upload an image file (JPEG, PNG, etc.)');
                    }
                }
            });

            function handleImageUpload() {
                const file = imageInput.files[0];
                if (file) {
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('Please upload an image file (JPEG, PNG, etc.)');
                        imageInput.value = '';
                        return;
                    }
                    
                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('Image size should not exceed 5MB');
                        imageInput.value = '';
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                    };
                    reader.readAsDataURL(file);
                }
            }

            // Fix the validateTokenValue function
function validateTokenValue() {
    // If tokenVal doesn't exist yet (e.g., when on borrowable view), return true
    const tokenValInput = document.getElementById('tokenVal');
    if (!tokenValInput) return true;
    
    const value = tokenValInput.value.trim();
    
    // Remove any previous error message
    const existingError = tokenValInput.parentElement.querySelector('.error-message');
    if (existingError) {
        existingError.remove();
    }
    
    // Check if empty
    if (value === '') {
        tokenValInput.style.borderColor = 'red';
        
        // Add error message for empty field
        const errorMsg = document.createElement('div');
        errorMsg.className = 'error-message';
        errorMsg.textContent = 'Token value is required';
        errorMsg.style.color = 'red';
        errorMsg.style.fontSize = '0.8rem';
        errorMsg.style.marginTop = '5px';
        
        tokenValInput.parentElement.appendChild(errorMsg);
        return false;
    }
    
    // Check if it's a valid number
    if (!/^[0-9]+$/.test(value)) {
        // Not a valid number, add error styling
        tokenValInput.style.borderColor = 'red';
        
        // Add error message
        const errorMsg = document.createElement('div');
        errorMsg.className = 'error-message';
        errorMsg.textContent = 'Please enter a valid number';
        errorMsg.style.color = 'red';
        errorMsg.style.fontSize = '0.8rem';
        errorMsg.style.marginTop = '5px';
        
        tokenValInput.parentElement.appendChild(errorMsg);
        return false;
    } else {
        // Valid number, reset styling
        tokenValInput.style.borderColor = 'green';
        return true;
    }
}

// Add this to your DOMContentLoaded event handler to set up real-time validation
// Place this after defining typeOptions event listeners
document.addEventListener('click', function(e) {
    if (e.target && e.target.id === 'tokenVal') {
        // Add input event listener when the field is created and clicked
        e.target.addEventListener('input', validateTokenValue);
    }
});



            // Form submission
            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const itemType = document.querySelector('.type-option.active').dataset.type;
    
                // Only validate token value for tradeable items
                if (itemType === 'trade' && !validateTokenValue()) {
                    return; // Stop form submission if validation fails
                }

                const formData = new FormData();
                formData.append('name', document.getElementById('itemName').value);
                formData.append('description', document.getElementById('description').value);
                if (imageInput.files[0]) {
                    formData.append('image', imageInput.files[0]);
                }


                formData.append('type', itemType);

                if (itemType === 'borrow') {
                    const selectedDurations = Array.from(document.querySelectorAll('.duration-option.selected'))
                        .map(option => option.dataset.days);
                    if (selectedDurations.length === 0) {
                        alert('Please select at least one duration option');
                        return;
                    }
                    formData.append('durations', JSON.stringify(selectedDurations));
                } else {
                    // For tradable items, include the status
                    formData.append('status', statusSlider.checked ? 'traded' : 'available');

                    const tokenValInput = document.getElementById('tokenVal');
                    if (tokenValInput) {
                        formData.append('tokenValue', tokenValInput.value.trim());
                    }
                }

                try {
                    const response = await fetch('http://127.0.0.1:8808/upload/', {
                        method: 'POST',
                        body: formData,
                        credentials: 'include'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert('Item uploaded successfully!');
                        window.location.href = 'browse.html';
                    } else {
                        throw new Error(result.error || 'Failed to upload item');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert(error.message || 'An error occurred while uploading the item');
                }
            });

            // Duration options handling
            const durationOptions = document.querySelectorAll('.duration-option');
            durationOptions.forEach(option => {
                option.addEventListener('click', () => {
                    option.classList.toggle('selected');
                });
            });
    </script>
</body>
</html>