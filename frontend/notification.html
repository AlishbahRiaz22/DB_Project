<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VirtualTrade - Notifications</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    .notification-hero {
      height: 30vh;
      background-image: linear-gradient(rgba(63, 66, 46, 0.8), rgba(63, 66, 46, 0.6)), url('./resources/images/notification-banner.jpg');
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      text-align: center;
    }

    .notification-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 3rem 2rem;
    }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .notification-header h2 {
      color: var(--organic);
      font-weight: 500;
      margin: 0;
    }

    .notification-actions {
      display: flex;
      gap: 1rem;
    }

    .notification-actions button {
      background-color: var(--organic);
      color: white;
      padding: 0.6rem 1.2rem;
      border-radius: 30px;
      font-weight: 500;
      font-size: 0.9rem;
      transition: all 0.3s;
      border: none;
      cursor: pointer;
    }

    .notification-actions button:hover {
      background-color: #4a4d36;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .notification-card {
      background-color: white;
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: flex;
      position: relative;
      transition: all 0.3s ease;
      border-left: 4px solid var(--organic);
    }

    .notification-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .notification-card.trade {
      border-left-color: #e67e22;
    }

    .notification-card.borrow {
      border-left-color: #3498db;
    }

    .notification-card.system {
      border-left-color: #9b59b6;
    }

    .notification-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 1.5rem;
      flex-shrink: 0;
    }

    .notification-icon i {
      font-size: 1.5rem;
      color: var(--organic);
    }

    .notification-icon.trade i {
      color: #e67e22;
    }

    .notification-icon.borrow i {
      color: #3498db;
    }

    .notification-icon.system i {
      color: #9b59b6;
    }

    .notification-content {
      flex: 1;
    }

    .notification-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--natural);
      margin-bottom: 0.5rem;
    }

    .notification-message {
      color: #666;
      margin-bottom: 0.5rem;
      line-height: 1.5;
    }

    .notification-time {
      font-size: 0.85rem;
      color: #999;
    }

    .notification-actions-btn {
      display: flex;
      margin-top: 1rem;
      gap: 0.8rem;
    }

    .notification-btn {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }

    .notification-btn.primary {
      background-color: var(--organic);
      color: white;
    }

    .notification-btn.secondary {
      background-color: #f5f5f5;
      color: #555;
    }

    .notification-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .notification-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .notification-close:hover {
      background-color: #e0e0e0;
      transform: rotate(90deg);
    }

    .notification-close i {
      font-size: 0.9rem;
      color: #777;
    }

    .notification-filter {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 1rem;
    }

    .filter-option {
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-weight: 500;
      color: #777;
      transition: all 0.3s;
      border-radius: 20px;
    }

    .filter-option:hover {
      color: var(--organic);
    }

    .filter-option.active {
      background-color: var(--organic);
      color: white;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #777;
    }

    .empty-state i {
      font-size: 4rem;
      color: #ddd;
      margin-bottom: 1.5rem;
    }

    .empty-state h3 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      color: var(--natural);
    }

    .empty-state p {
      max-width: 500px;
      margin: 0 auto;
      line-height: 1.6;
    }

    .notification-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      background-color: var(--apricot);
      color: white;
      border-radius: 50%;
      font-size: 0.8rem;
      margin-left: 0.5rem;
    }
  </style>
</head>
<body>
  <header>
    <nav>
        <div class="logo"><a href="index.html">VirtualTrade</a></div>
        <div class="nav-links">
          <a href="index.html">Home</a>
          <a href="category.html">Categories</a>
          <a href="how-it-works.html">How It Works</a>
          <a href="about.html">About Us</a>
        </div>
        <div class="auth-buttons">
            <button class="login-btn" onclick="location.href='login.html'">Login</button>
            <button class="signup-btn" onclick="location.href='signup.html'">Sign Up</button>
        </div>
    </nav>
  </header>

  <main>
    <section class="notification-hero">
      <div>
        <h1>Notifications</h1>
        <p>Stay updated with your account activity</p>
      </div>
    </section>

    <section class="notification-container">
      <div class="notification-header">
        <h2>Your Notifications <span class="notification-count" id="notification-count">0</span></h2>
        <div class="notification-actions">
          <button id="mark-all-read-btn">Mark All as Read</button>
        </div>
      </div>

      <div class="notification-filter">
        <div class="filter-option active" data-filter="all">All</div>
      </div>

      <div id="notifications-container">
        <!-- Notifications will be loaded here -->
        <div class="empty-state" id="empty-state" style="display: none;">
          <i class="far fa-bell-slash"></i>
          <h3>No Notifications</h3>
          <p>You're all caught up! There are no new notifications at the moment.</p>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="footer-content">
      <div class="footer-col">
        <h3>VirtualTrade</h3>
        <p>A community platform for sustainable trading, sharing, and reducing waste through conscious consumption.</p>
      </div>

      <div class="footer-col">
        <h3>Quick Links</h3>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="browse.html">Browse Items</a></li>
            <li><a href="about.html">About Us</a></li>
        </ul>
      </div>

      <div class="footer-col">
        <h3>Categories</h3>
        <ul>
          <li><a class="cat-links">Electronics</a></li>
          <li><a class="cat-links">Clothing</a></li>
          <li><a class="cat-links">Books</a></li>
          <li><a class="cat-links">Furniture</a></li>
        </ul>
      </div>

      <div class="footer-bottom">
        <p>&copy; 2025 VirtualTrade. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Category link functionality from profile page
      const links = document.querySelectorAll('.cat-links');
      links.forEach(link => {
        link.addEventListener('click', function(event) {
          event.preventDefault();
          const value = this.textContent.trim();
          const url = `browse.html?category=${value}`;
          window.location.href = url;
        });
      });

      // Get notification filter options
      const filterOptions = document.querySelectorAll('.filter-option');
      const currentFilter = 'all';

      // Function to update nav menu
      async function updateNavigation() {
        try {
          const response = await fetch('http://127.0.0.1:8808/user/', {
            method: 'GET',
            credentials: 'include'
          });
          
          if (response.status === 200) {
            const loginBtn = document.querySelector('.login-btn');
            const signupBtn = document.querySelector('.signup-btn');
            
            // Change login button to user profile icon
            loginBtn.textContent = "";
            loginBtn.style.backgroundImage = "url('./resources/images/user.png')";
            loginBtn.style.backgroundSize = "cover";
            loginBtn.style.width = "40px";
            loginBtn.style.height = "40px";
            loginBtn.style.borderRadius = "50%";
            loginBtn.style.border = "none";
            loginBtn.style.cursor = "pointer";
            loginBtn.style.marginRight = "10px";
            loginBtn.style.padding = "0px";
            loginBtn.style.backgroundColor = "transparent";
            loginBtn.onclick = function() {
              window.location.href = "profile.html";
            };
            
            // Change signup button to logout
            signupBtn.textContent = "Logout";
            signupBtn.onclick = async function() {
              try {
                const response = await fetch('http://127.0.0.1:8808/logout', {
                  method: "POST",
                  credentials: 'include'
                });
                
                if(response.status === 200) {
                  window.localStorage.setItem('loggedIn', 'false');
                  window.location.href = "index.html";
                } else {
                  alert("Error logging out. Please try again.");
                }
              } catch (error) {
                console.error('Logout error:', error);
                alert("Error logging out. Please try again.");
              }
            };
          } else {
            // User is not logged in, redirect to login
            window.location.href = "login.html";
          }
        } catch (error) {
          console.error('Authentication check error:', error);
          alert("Error checking authentication. Please try again.");
        }
      }

      // Function to load notifications
      async function loadNotifications() {
        try {
          const response = await fetch('http://127.0.0.1:8808/notifications', {
            method: 'GET',
            credentials: 'include'
          });
          
          if (response.status === 200) {
            const data = await response.json();
            const container = document.getElementById('notifications-container');
            const emptyState = document.getElementById('empty-state');
            
            // console.log(data); // Debugging line to check the data structure
            // Update notification count
            document.getElementById('notification-count').textContent = data.length;
            
            // Hide all cards first (for filtering)
            container.querySelectorAll('.notification-card').forEach(card => {
              card.style.display = 'none';
            });
            
            // If there are no notifications, show empty state
            if (data.length === 0) {
              emptyState.style.display = 'block';
              return;
            } else {
              emptyState.style.display = 'none';
            }
            
            // Clear container if loading full set
            if (currentFilter === 'all') {
              container.innerHTML = '';
            }
            
            // Create notification cards
            data.forEach((notification, index) => {
              
              // Create notification card
              const card = document.createElement('div');
              card.className = `notification-card`;
              card.setAttribute('data-id', notification.notification_id);
              
              // Set icons based on notification type
            let iconClass = 'fas fa-bell';
              
              // Format time
              const notificationTime = new Date(notification.creation_date);
              const now = new Date();
              const diffTime = Math.abs(now - notificationTime);
              const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
              const diffHours = Math.floor((diffTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
              const diffMinutes = Math.floor((diffTime % (1000 * 60 * 60)) / (1000 * 60));
              
              let timeString = '';
              if (diffDays > 0) {
                timeString = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
              } else if (diffHours > 0) {
                timeString = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
              } else if (diffMinutes > 0) {
                timeString = `${diffMinutes} minute${diffMinutes > 1 ? 's' : ''} ago`;
              } else {
                timeString = 'Just now';
              }
              
              // Create notification card HTML
              card.innerHTML = `
                <div class="notification-icon">
                  <i class="${iconClass}"></i>
                </div>
                <div class="notification-content">
                  <div class="notification-title">${index + 1}</div>
                  <div class="notification-message">${notification.notification}</div>
                  <div class="notification-time">${timeString}</div>
                </div>
                <div class="notification-close" data-id="${notification.notification_id}">
                  <i class="fas fa-times"></i>
                </div>
              `;
              
              container.appendChild(card);
              
              // Add event listener to close button
              card.querySelector('.notification-close').addEventListener('click', function(e) {
                e.stopPropagation();
                const notificationId = this.getAttribute('data-id');
                markAsRead(notificationId);
              });
              
            });
          } else {
            console.error('Failed to load notifications', response.status);
            document.getElementById('empty-state').style.display = 'block';
          }
        } catch (error) {
          console.error('Error loading notifications:', error);
          document.getElementById('empty-state').style.display = 'block';
        }
      }
      
      // Function to mark notification as read
      async function markAsRead(notificationId, callback) {
        try {
          const response = await fetch(`http://127.0.0.1:8808/notifications/${notificationId}`, {
            method: 'PUT',
            credentials: 'include'
          });
          
          if (response.status === 200) {
            // Remove the notification card with animation
            const card = document.querySelector(`.notification-card[data-id="${notificationId}"]`);
            card.style.opacity = '0';
            card.style.transform = 'translateX(100px)';
            
            setTimeout(() => {
              card.remove();
              
              // Update notification count
              const countElement = document.getElementById('notification-count');
              const currentCount = parseInt(countElement.textContent);
              countElement.textContent = currentCount - 1;
              
              // Show empty state if no notifications left
              if (currentCount - 1 === 0) {
                document.getElementById('empty-state').style.display = 'block';
              }
              
              // Execute callback if provided
              if (callback) callback();
            }, 300);
          } else {
            console.error('Failed to mark notification as read');
          }
        } catch (error) {
          console.error('Error marking notification as read:', error);
        }
      }
      
      // Function to mark all notifications as read
      async function markAllAsRead() {
        try {
          const response = await fetch('http://127.0.0.1:8808/notifications/mark-all-read', {
            method: 'POST',
            credentials: 'include'
          });
          
          if (response.status === 200) {
            // Remove all notification cards with animation
            const cards = document.querySelectorAll('.notification-card');
            cards.forEach(card => {
              card.style.opacity = '0';
              card.style.transform = 'translateX(100px)';
            });
            
            setTimeout(() => {
              document.getElementById('notifications-container').innerHTML = '';
              document.getElementById('notification-count').textContent = '0';
              document.getElementById('empty-state').style.display = 'block';
            }, 300);
          } else {
            console.error('Failed to mark all notifications as read');
          }
        } catch (error) {
          console.error('Error marking all notifications as read:', error);
        }
      }

      // Add event listener to "Mark All as Read" button
      document.getElementById('mark-all-read-btn').addEventListener('click', markAllAsRead);
      
      // Initial load
      updateNavigation();
      loadNotifications();
      
      
    });
  </script>
</body>
</html>